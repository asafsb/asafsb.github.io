<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Asaf Blubshtein">

  
  
  
    
  
  <meta name="description" content="For certain tests and demos, I occasionally need to connect my home lab to our VMW on AWS SDDC. Since I can&rsquo;t justify the cost of a Direct Connect port to my home lab my options are either route or policy-based VPN. Unless there&rsquo;s a specific use-case for policy-based, route-based VPN (RBVPN) is definitely  my preferred method.
Currently, I&rsquo;m using a pfSense router/firewall for my home lab, which meant the first step was to select which BGP package I should install. At first, I was going to configure BGP using OpenBGPD as it seemed more common, but I decided to use FRR instead.">

  
  <link rel="alternate" hreflang="en-us" href="https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/">

  


  
  
  
  <meta name="theme-color" content="#FDFDFD">
  

  
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/tomorrow-night-blue.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/tomorrow-night-blue.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      
        
      

      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-161733961-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-161733961-1', { 'anonymize_ip': true });

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu2d386f00a90cc1e6a45c94eb95a50635_27399_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu2d386f00a90cc1e6a45c94eb95a50635_27399_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/">

  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@AsafBlubshtein">
  <meta property="twitter:creator" content="@AsafBlubshtein">
  
  <meta property="og:site_name" content="Software-Defined Coffee">
  <meta property="og:url" content="https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/">
  <meta property="og:title" content="Configuring Route Based VPN Between VMware Cloud on AWS and pfSense | Software-Defined Coffee">
  <meta property="og:description" content="For certain tests and demos, I occasionally need to connect my home lab to our VMW on AWS SDDC. Since I can&rsquo;t justify the cost of a Direct Connect port to my home lab my options are either route or policy-based VPN. Unless there&rsquo;s a specific use-case for policy-based, route-based VPN (RBVPN) is definitely  my preferred method.
Currently, I&rsquo;m using a pfSense router/firewall for my home lab, which meant the first step was to select which BGP package I should install. At first, I was going to configure BGP using OpenBGPD as it seemed more common, but I decided to use FRR instead."><meta property="og:image" content="https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/featured.png">
  <meta property="twitter:image" content="https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/featured.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2021-05-19T01:00:11&#43;00:00">
    
    <meta property="article:modified_time" content="2021-05-19T01:00:11&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/"
  },
  "headline": "Configuring Route Based VPN Between VMware Cloud on AWS and pfSense",
  
  "image": [
    "https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/featured.png"
  ],
  
  "datePublished": "2021-05-19T01:00:11Z",
  "dateModified": "2021-05-19T01:00:11Z",
  
  "author": {
    "@type": "Person",
    "name": "Asaf Blubshtein"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Software-Defined Coffee",
    "logo": {
      "@type": "ImageObject",
      "url": "https://softwaredefinedcoffee.com/images/logo_hu6a9919c281d1691f5c19a9c9499d0583_79377_192x192_fit_lanczos_2.png"
    }
  },
  "description": "For certain tests and demos, I occasionally need to connect my home lab to our VMW on AWS SDDC. Since I can\u0026rsquo;t justify the cost of a Direct Connect port to my home lab my options are either route or policy-based VPN. Unless there\u0026rsquo;s a specific use-case for policy-based, route-based VPN (RBVPN) is definitely  my preferred method.\nCurrently, I\u0026rsquo;m using a pfSense router/firewall for my home lab, which meant the first step was to select which BGP package I should install. At first, I was going to configure BGP using OpenBGPD as it seemed more common, but I decided to use FRR instead."
}
</script>

  

  


  
  
  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js" integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css" integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin="anonymous">
  
  <script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#424242",
          "text": "#fff"
        },
        "button": {
          "background": "#606060",
          "text": "#FDFDFD"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "/privacy/"
      }
    })});
  </script>



  





  <title>Configuring Route Based VPN Between VMware Cloud on AWS and pfSense | Software-Defined Coffee</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  






  


<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/"><img src="/images/logo_hu6a9919c281d1691f5c19a9c9499d0583_79377_0x70_resize_lanczos_2.png" alt="Software-Defined Coffee"></a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/"><img src="/images/logo_hu6a9919c281d1691f5c19a9c9499d0583_79377_0x70_resize_lanczos_2.png" alt="Software-Defined Coffee"></a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#header"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>About</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      

      

    </ul>

  </div>
</nav>


  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>Configuring Route Based VPN Between VMware Cloud on AWS and pfSense</h1>

  

  
    



<div class="article-metadata">

  
  
  
  
  <div>
    

  
  <span><a href="/authors/admin/">Asaf Blubshtein</a></span>
  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    May 19, 2021
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    9 min read
  </span>
  

  
  
  

  
  
  
  <span class="middot-divider"></span>
  <a class="gc-counter" data-url="https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/" href="/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/#graphcomment"></a>
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/categories/vmware-cloud-on-aws/">VMware Cloud on AWS</a>, <a href="/categories/networking/">Networking</a></span>
  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style">
      <p>For certain tests and demos, I occasionally need to connect my home lab to our VMW on AWS SDDC. Since I can&rsquo;t justify the cost of a Direct Connect port to my home lab my options are either route or policy-based VPN. Unless there&rsquo;s a specific use-case for policy-based, route-based VPN (RBVPN) is definitely <u>
<a href="https://vmc.techzone.vmware.com/vmc-arch/docs/network/vmc-aws-ipsec-vpn#" target="_blank" rel="noopener">my preferred method</a></u>.</p>
<p>Currently, I&rsquo;m using a pfSense router/firewall for my home lab, which meant the first step was to select which BGP package I should install. At first, I was going to configure BGP using OpenBGPD as it seemed more common, but I decided to use FRR instead. The main reason was that at the time I was also studying for the NSX-V VCAP Deploy exam and wanted to be able to leverage both OSPF and BGP. Another reason was that it seems as though FRR is being recommended over OpenBGPD and Quagga OSPF as pfSense&rsquo;s dynamic routing package of choice.</p>
<h3 id="planning-and-pre-requisites">Planning and Pre-requisites</h3>
<ul>
<li>There are certain values in a RBVPN that have to be identical in both sites and some that must be different for connectivity to work:</li>
</ul>
<table>
<thead>
<tr>
<th>Setting/Value</th>
<th>Description</th>
<th>Values I used</th>
</tr>
</thead>
<tbody>
<tr>
<td>Local public IP</td>
<td>The public IP associated with the pfSense. If it&rsquo;s behind a NAT, note the private IP as well</td>
<td><u>
<a href="https://www.whatsmyip.org/" target="_blank" rel="noopener">My public IP</a></u> and 192.168.1.254</td>
</tr>
<tr>
<td>Remote public IP</td>
<td>The VPN Public IP of the SDDC</td>
<td></td>
</tr>
<tr>
<td>Local BGP ASN</td>
<td>The ASN that will be assigned to pfSense</td>
<td>65025</td>
</tr>
<tr>
<td>SDDC BGP ASN</td>
<td>The ASN that will be assigned to the SDDC&rsquo;s BGP instance. Must be different than the local BGP ASN</td>
<td>65001</td>
</tr>
<tr>
<td>IPsec IKE version (for phase 1 and 2)</td>
<td>Select a setting that is <u>
<a href="https://docs.vmware.com/en/VMware-Cloud-on-AWS/services/com.vmware.vmc-aws.networking-security/GUID-5566A021-ECF7-41C4-B899-30924EBCD81F.html" target="_blank" rel="noopener">supported by VMW on AWS</a></u>. The setting must be identical in both sites for an IPsec session to establish</td>
<td>IKEv2</td>
</tr>
<tr>
<td>IPsec encryption parameters (for phase 1 and 2)</td>
<td>Select values that are <u>
<a href="https://docs.vmware.com/en/VMware-Cloud-on-AWS/services/com.vmware.vmc-aws.networking-security/GUID-5566A021-ECF7-41C4-B899-30924EBCD81F.html" target="_blank" rel="noopener">supported by VMW on AWS</a></u>. Values must be identical in both sites for an IPsec session to establish</td>
<td>AES GCM 256, 128-bit key, SHA256, DH14</td>
</tr>
<tr>
<td>Pre-shared key for IPsec</td>
<td>Will be used to authenticate the IPsec session between pfSense and the SDDC</td>
<td>Generated using pfSense</td>
</tr>
<tr>
<td>Local BGP IP</td>
<td>An IP in a network that will only be used to establish a BGP neighbor relationship between pfSense and the SDDC. Doesn&rsquo;t need to be large or routable, preferably in the 169.254.0.0 range</td>
<td>169.254.225.25/30</td>
</tr>
<tr>
<td>SDDC BGP IP</td>
<td>An IP in the same subnet as the local BGP IP</td>
<td>169.254.225.26/30</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Configure port forwarding (Optional)</strong> - If your pfSense is not directly connected to the internet you&rsquo;ll need to enable port forwarding in your public-facing router/firewall and forward UDP port 4500 to your pfSense&rsquo;s private IP</li>
</ul>
<h4 id="uin-vmw-on-awsu"><u>In VMW on AWS:</u></h4>
<ul>
<li><strong>Note the VPN public IP</strong> - In the SDDC you&rsquo;d like to connect to, navigate to the <strong>Networking &amp; Security</strong> section. The <strong>Overview</strong> tab should have the <strong>VPN Public IP</strong> listed:</li>
</ul>
<p><img src="image1.png" alt="VPN Public IP"></p>
<ul>
<li><strong>Note/change the VMW on AWS ASN</strong> - The default ASN is 65000. To validate or edit the ASN, within the <strong>Networking &amp; Security</strong> section, navigate to <strong>VPN</strong> &gt; <strong>Route Based</strong>. Click <strong>Edit Local ASN</strong>. You can now change the number to an ASN that is unique in your BGP environment. In this configuration I will use <strong>65001</strong>.</li>
</ul>
<p><img src="image2.png" alt="Edit VMW on AWS ASN">
<img src="image3.png" alt="VMW on AWS ASN"></p>
<h4 id="uin-pfsenseu"><u>In pfSense:</u></h4>
<ul>
<li><strong>Allow APIPA traffic (optional)</strong> - By default VMW on AWS allows RBVPN BGP sessions to be formed using the 169.254.0.0/16 range. pfSense drops that range by default. To configure pfSense to allow that range navigate to <strong>System</strong> &gt; <strong>Advanced</strong>. Go to the <strong>Firewall &amp; NAT</strong> tab and check <strong>Allow APIPA traffic</strong>. If APIPA traffic is not allowed the range that will be used for the BGP session should be permitted in the Compute Gateway firewall in VMW on AWS.</li>
</ul>
<p><img src="image4.png" alt="Allow APIPA traffic"></p>
<ul>
<li><strong>Install FRR</strong> - FRR will add dynamic routing capabilities to pfSense using BGP and OSPF. To install FRR navigate to <strong>System</strong> &gt; <strong>Package Manager</strong> and select the <strong>Available Packages</strong> tab. Search for <strong>FRR</strong> and click <strong>Install</strong>. Once the installation is finished successfully  FRR will appear under <strong>Installed Packages</strong>.</li>
</ul>
<p><img src="image5.png" alt="FRR Installation"></p>
<h3 id="pfsense-configuration">pfSense configuration</h3>
<p><strong>Step 1</strong> - Conigure IPsec Tunnel</p>
<ul>
<li>Navigate to <strong>VPN</strong> &gt; <strong>IPsec</strong> and click <strong>Add P1</strong></li>
<li>Configure the following phase 1 settings (these settings will have to match when configured in VMW on AWS):
<ul>
<li><strong>Key Exchange version</strong> - IKEv1 or IKEv2. I selected IKEv2</li>
<li><strong>Interface</strong> - the WAN interface of your pfSense</li>
<li><strong>Remote Gateway</strong> - the <strong>VPN Public IP</strong> of the SDDC</li>
<li><strong>Pre-Shared Key</strong> - enter a shared key or generate one</li>
<li><strong>Encryption Algorithm</strong> - select encryption the desired values that are <u>
<a href="https://docs.vmware.com/en/VMware-Cloud-on-AWS/services/com.vmware.vmc-aws.networking-security/GUID-5566A021-ECF7-41C4-B899-30924EBCD81F.html" target="_blank" rel="noopener">supported by VMW on AWS</a></u>. I selected the following:
<ul>
<li><strong>Algorithm</strong> - AES256-GCM</li>
<li><strong>Key length</strong> - 128</li>
<li><strong>Hash</strong> - SHA256</li>
<li><strong>DH Group</strong> - 14 (2048 bit)</li>
</ul>
</li>
</ul>
</li>
<li>On the newly created IPsec tunnel, Click <strong>Show Phase 2 Entries</strong> and then <strong>Add P2</strong></li>
<li>Configure the following phase 2 settings:
<ul>
<li><strong>Mode</strong> - Routed (VTI)</li>
<li><strong>Local Network</strong> - <strong>Address</strong> (not <em>Network</em>!). Under <strong>Address</strong> enter the local BGP IP designated for pfSense. I used <strong>169.254.225.25</strong></li>
<li><strong>Remote Network</strong> - <strong>Address</strong> (not <em>Network</em>!). Under <strong>Address</strong> enter the remote BGP IP designated for VMWonAWS. I used <strong>169.254.225.26</strong></li>
<li>Similar to the encryption configuration in Phase 1, select encryption values that are <u>
<a href="https://docs.vmware.com/en/VMware-Cloud-on-AWS/services/com.vmware.vmc-aws.networking-security/GUID-5566A021-ECF7-41C4-B899-30924EBCD81F.html" target="_blank" rel="noopener">supported by VMW on AWS</a></u>. I selected similar values to the ones I set in Phase 1:
<ul>
<li><strong>Algorithm</strong> - AES256-GCM</li>
<li><strong>Key length</strong> - 128</li>
<li><strong>Hash</strong> - SHA256</li>
<li><strong>PFS Key Group</strong> - 14 (2048 bit)</li>
</ul>
</li>
</ul>
</li>
<li>Validate both Phase 1 and Phase 2 configurations and click <strong>Apply Changes</strong></li>
</ul>





  
  











<figure >


  <a data-fancybox="" href="/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/image6_hu2c75ae82bc5d70677c26f83e2685b1d8_58443_2000x2000_fit_lanczos_2.png" >


  <img data-src="/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/image6_hu2c75ae82bc5d70677c26f83e2685b1d8_58443_2000x2000_fit_lanczos_2.png" class="lazyload" alt="IPsec Configuration" width="1148" height="347">
</a>



</figure>

<p><strong>Step 2</strong> - Assign the IPsec interface. This step enables the IPsec tunnel created in the previous step as a virtual interface for pfSense, so it can be leveraged by FRR to establish a BGP connection.</p>
<ul>
<li>Navigate to <strong>Interfaces</strong> &gt; <strong>Assignments</strong></li>
<li>At the bottom, under <strong>Available network ports</strong>, select the newly created IPsec tunnel and click <strong>Add</strong></li>
</ul>
<p><img src="image7.png" alt="IPsec interface"></p>
<ul>
<li>The new interface is added as <strong>OPT#</strong>. In my case it was added as OPT4. Click the interface name</li>
<li>Check <strong>Enable Interface</strong> and provide a <strong>Description</strong> to make it easier to identify the interface</li>
<li>Click <strong>Save</strong></li>
</ul>
<p><img src="image8.png" alt="IPsec Interface enablement"></p>
<p><strong>Step 3</strong> - Allow traffic via the IPsec interface. By default pfSense will block any traffic on newly added interfaces. For the BGP connection to establish and for traffic to flow several allow rules should be opened.</p>
<ul>
<li>Navigate to <strong>Firewall</strong> &gt; <strong>Rules</strong></li>
<li>Select the <strong>IPsec</strong> interfaces</li>
<li>Create inbound and outbound rules that will match the traffic you want to allow communicating over the RBVPN. Don&rsquo;t forget to also enable the BGP communication between pfSense and the SDDC. For this scenario I&rsquo;m going to allow all traffic</li>
</ul>
<p><img src="image9.png" alt="IPsec Firewall Rules"></p>
<p><strong>Step 4</strong> - Configure FRR. Now that IPsec is configured on the pfSense side, we are ready to configure FRR and BGP.</p>
<ul>
<li>Navigate to <strong>Services</strong> &gt; <strong>FRR Global/Zebra</strong></li>
<li>Check <strong>Enable FRR</strong></li>
<li>Set the <strong>Default Router ID</strong>. You can specify it individually per routing protocol. I set it to the pfSense&rsquo;s BGP IP, <strong>169.254.225.25</strong></li>
<li>Set a <strong>Master Password</strong>. This password is only used by FRRs internal daemons, so set it to whatever you want</li>
<li>Click <strong>Save</strong></li>
</ul>
<p><img src="image10.png" alt="FRR Global Settings"></p>
<p><strong>Step 5</strong> - Configure FRR&rsquo;s BGP. Note that I&rsquo;m not going into the (many) configuration options possible in BGP. This is just going to be a minimal setup to enable communication and route exchanges.</p>
<ul>
<li>Navigate to <strong>Services</strong> &gt; <strong>FRR BGP</strong></li>
<li>Check <strong>Enable BGP Routing</strong></li>
<li>Set the <strong>Local AS</strong> to a value that is different than the AS in VMW on AWS. In my lab it is set to <strong>65025</strong></li>
<li>Specify the <strong>Router ID</strong> if you&rsquo;d like it to be different than the one specified in <strong>step 4</strong></li>
</ul>
<p><img src="image11.png" alt="FRR BGP Settings"></p>
<ul>
<li>Under <strong>Network Distribution</strong>, you can control what routes are advertised via BGP. Since I didn&rsquo;t want all of my lab and home subnets to be advertised, I decided to specify the ones I wanted to use for testing purposes</li>
<li>Click <strong>Save</strong></li>
</ul>
<p><img src="image12.png" alt="BGP Network Distribution"></p>
<p><strong>Step 6</strong> - Configure the SDDC&rsquo;s Edge as a BGP neighbor. Similar to the previous step, there&rsquo;s a lot of BGP options here, but I&rsquo;m just going to cover the basic to establish connectivity.</p>
<ul>
<li>In the <strong>FRR BGP</strong> view, select the <strong>Neighbors</strong> tab and click <strong>Add</strong></li>
<li>Under <strong>Name/Address</strong> set the remote BGP IP of the SDDC. In my case it&rsquo;s <strong>169.254.225.26</strong></li>
<li>Set a <strong>Description</strong> to easily identify this neighbor</li>
<li>Set the <strong>Remote AS</strong> to the ASN configured in VMW on AWS</li>
<li>Click <strong>Save</strong></li>
</ul>
<p><img src="image13.png" alt="BGP neighbor Settings"></p>
<h3 id="vmw-on-aws-configuration">VMW on AWS configuration</h3>
<p><strong>Step 7</strong> - Configure RBVPN in VMW on AWS</p>
<ul>
<li>Navigate to <strong>Networking &amp; Security</strong> &gt; <strong>VPN</strong>. By default you should be in the <strong>Route Based</strong> tab</li>
<li>Click <strong>Add VPN</strong></li>
<li>Configure the following in the top section:
<ul>
<li><strong>Name</strong> - Descriptive name to identify the VPN</li>
<li><strong>Local IP Address</strong> - Select the <strong>Public IP</strong> from the drop down list. <strong>Note</strong>: this cannot be changed later</li>
<li><strong>Remote Public IP Address</strong> - The public IP where the pfSense is reachable</li>
<li><strong>BGP Local IP/Prefix Length</strong> - Enter the SDDC&rsquo;s BGP IP and prefex length. I used <strong>169.254.225.26/30</strong>. <strong>Note</strong>: this cannot be changed later</li>
<li><strong>BGP Remote IP</strong> - Enter the pfSense BGP IP. I used <strong>169.254.225.25</strong>. <strong>Note</strong>: this cannot be changed later</li>
<li><strong>BGP Neighbor ASN</strong> - Enter the ASN configured in pfSense. I used <strong>65025</strong></li>
<li><strong>Preshared Key</strong> - Enter the same pre-shared key entered in <strong>step 1</strong></li>
<li><strong>Remote Private IP</strong> - If the pfSense is behind a NAT, enter the private IP of the pfSense. I used <strong>192.168.1.254</strong>, which is the WAN interface</li>
</ul>
</li>
<li>Configure the following in the bottom section (all values should correlate to the IPsec config in <strong>step 1</strong>):
<ul>
<li><strong>IKE Encryption</strong> - Correlates to pfSense&rsquo;s Phase 1 algorithm. I configured <strong>AES GCM 256</strong></li>
<li><strong>IKE Digest Algorithm</strong> - Correlates to pfSense&rsquo;s Phase 1 hash. I configured <strong>None</strong>, as this is required in VMWonAWS <u>
<a href="https://docs.vmware.com/en/VMware-Cloud-on-AWS/services/com.vmware.vmc-aws.networking-security/GUID-5AF45CE6-FA53-45C0-83E5-25F8E3A055E9.html" target="_blank" rel="noopener">when using GCM</a></u></li>
<li><strong>IKE Type</strong> - Correlates to pfSense&rsquo;s Phase 1 key exchange version. I configured <strong>IKE V2</strong></li>
<li><strong>Diffie Hellman</strong> - Correlates to pfSense&rsquo;s Phase 1 DH Group. I configured <strong>14</strong></li>
<li><strong>Tunnel Encryption</strong> - Correlates to pfSense&rsquo;s Phase 2 algorithm. I configured <strong>AES GCM 256</strong></li>
<li><strong>Tunnel Digest Algorithm</strong> - Correlates to pfSense&rsquo;s Phase 2 hash. I configured <strong>None</strong>, as this is required in VMWonAWS <u>
<a href="https://docs.vmware.com/en/VMware-Cloud-on-AWS/services/com.vmware.vmc-aws.networking-security/GUID-5AF45CE6-FA53-45C0-83E5-25F8E3A055E9.html" target="_blank" rel="noopener">when using GCM</a></u></li>
<li><strong>Perfect Forward Secrecy</strong> - Correlates to pfSense&rsquo;s Phase 2 PFS. I set it to <strong>Enabled</strong></li>
</ul>
</li>
<li>Click <strong>Save</strong></li>
</ul>





  
  











<figure >


  <a data-fancybox="" href="/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/image14_hu9ef110cd4d0a67a897102658570c3244_76439_2000x2000_fit_lanczos_2.png" >


  <img data-src="/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/image14_hu9ef110cd4d0a67a897102658570c3244_76439_2000x2000_fit_lanczos_2.png" class="lazyload" alt="VMW on AWS RBVPN settings" width="1222" height="460">
</a>



</figure>

<p><strong>Step 8 (Optional)</strong> - Allow the BGP IPs in the Gateway Firewall if a they are not in the 169.254.0.0/16 range</p>
<ul>
<li>Navigate to <strong>Networking &amp; Security</strong> &gt; <strong>Gateway Firewall</strong>. By default you should be in the <strong>Compute Gateway</strong> tab</li>
<li>Click <strong>+ Add Rule</strong></li>
<li>Make sure the <strong>Sources</strong> and <strong>Destination</strong> are the subnet/IPs that are used by both BGP interfaces. Under <strong>Applied To</strong> apply the rule only to the <strong>VPN Tunnel Interface</strong></li>
<li>Click <strong>Publish</strong></li>
</ul>
<h3 id="validate-connectivity">Validate Connectivity</h3>
<p>At this point the IPsec tunnels should be up and the BGP session should establish and extend routes. We can validate connectivity in VMWonAWS and in pfSense.</p>
<p><strong>In VMW on AWS</strong> - navigate to <strong>Networking &amp; Security</strong> &gt; <strong>VPN</strong>. In the <strong>Route Based</strong> tab verify that both the <strong>Status</strong> and <strong>BGP Remote IP</strong> are showing a green circle. You can also expand the view and view the learned and advertised routes.</p>
<p><img src="image15.png" alt="VMW on AWS RBVPN settings - Established Tunnel"></p>
<p><strong>In pfSense</strong> - navigate to <strong>Status</strong> &gt; <strong>FRR</strong>. In the <strong>BGP</strong> tab there are several places where you can validate the established connection. The main ones are:</p>
<ul>
<li>Under the <strong>BGP Routes</strong> you can view the learned routes</li>
<li><strong>BGP Neighbors</strong> will present a lot of information about the neighbor connection. The important thing is to make sure the <strong>BGP State</strong> is <strong>Established</strong></li>
</ul>
<p><img src="image16.png" alt="FRR BGP Neighbor Status"></p>

    </div>

    



<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/vmc-on-aws/">VMC on AWS</a>
  
  <a class="badge badge-light" href="/tags/vmwonaws/">VMWonAWS</a>
  
  <a class="badge badge-light" href="/tags/vmware-cloud-on-aws/">VMware Cloud on AWS</a>
  
  <a class="badge badge-light" href="/tags/pfsense/">pfSense</a>
  
  <a class="badge badge-light" href="/tags/vpn/">VPN</a>
  
  <a class="badge badge-light" href="/tags/rbvpn/">RBVPN</a>
  
  <a class="badge badge-light" href="/tags/route-based-vpn/">Route Based VPN</a>
  
</div>



<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/&amp;text=Configuring%20Route%20Based%20VPN%20Between%20VMware%20Cloud%20on%20AWS%20and%20pfSense" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/&amp;t=Configuring%20Route%20Based%20VPN%20Between%20VMware%20Cloud%20on%20AWS%20and%20pfSense" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/&amp;title=Configuring%20Route%20Based%20VPN%20Between%20VMware%20Cloud%20on%20AWS%20and%20pfSense" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Configuring%20Route%20Based%20VPN%20Between%20VMware%20Cloud%20on%20AWS%20and%20pfSense%20https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://reddit.com/submit?url=https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/&amp;title=Configuring%20Route%20Based%20VPN%20Between%20VMware%20Cloud%20on%20AWS%20and%20pfSense" target="_blank" rel="noopener" class="share-btn-reddit">
          <i class="fab fa-reddit-alien"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://pinterest.com/pin/create/link/?url=https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/&amp;description=Configuring%20Route%20Based%20VPN%20Between%20VMware%20Cloud%20on%20AWS%20and%20pfSense" target="_blank" rel="noopener" class="share-btn-pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Configuring%20Route%20Based%20VPN%20Between%20VMware%20Cloud%20on%20AWS%20and%20pfSense&amp;body=https://softwaredefinedcoffee.com/post/2021-05-19-configuring-route-based-vpn-between-vmware-cloud-on-aws-and-pfsense/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
  </ul>
</div>












  
    
    





  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <img class="avatar mr-3 avatar-circle" src="/authors/admin/avatar_hu5918950e2ae61a1f706202ec8104aaf6_119822_270x270_fill_lanczos_center_2.png" alt="Asaf Blubshtein">
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://softwaredefinedcoffee.com/">Asaf Blubshtein</a></h5>
      <h6 class="card-subtitle">Cloud Customer Success Architect</h6>
      <p class="card-text">My current role focuses on VMware Cloud on AWS. I spend the rest of my time with my wife, our two cats, my home-lab, and our espresso machine.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
    <li>
      <a href="mailto:sdcoffee.blog@gmail.com" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/asaf-blubshtein" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/AsafBlubshtein" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/asafsb" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/index.xml" >
        <i class="fas fa-rss"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


  





<section id="comments">
  
    <div id="graphcomment"></div>

  
</section>




<div class="article-widget">
  
<div class="post-nav">
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Next</div>
    <a href="/post/2021-06-04-testing-in-service-upgrade-for-hcx-network-extension-appliances/" rel="next">Testing In-Service Upgrade for HCX Network Extension Appliances</a>
  </div>
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="/post/2020-07-16-powershell-module-to-manage-workload-placement-in-vmwonaws-stretched-clusters/" rel="prev">PowerShell Module to Manage Workload Placement in VMware Cloud on AWS Stretched Clusters</a>
  </div>
  
</div>

</div>



  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="/post/2020-07-16-powershell-module-to-manage-workload-placement-in-vmwonaws-stretched-clusters/">PowerShell Module to Manage Workload Placement in VMware Cloud on AWS Stretched Clusters</a></li>
      
      <li><a href="/post/2020-05-14-configuring-l2vpn-high-availability-in-vmw-on-aws/">Configuring L2VPN High Availability in VMware Cloud on AWS</a></li>
      
    </ul>
  </div>
  



  </div>
</article>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/powershell.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/shell.min.js"></script>
        
      

    

    
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.4aaf2d64e50f8e54cf66dcc54147a22e.js"></script>

    






<script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script>addBackToTop({
  diameter: 56,
  backgroundColor: '#424242',
  textColor: '#fff'
})</script>





<script type="text/javascript">

    

  var gc_params = {
    graphcomment_id: 'Software-Defined-Coffee'
  };

   


  (function() {
    var gc = document.createElement('script'); gc.type = 'text/javascript'; gc.async = true;
    gc.src = 'https://graphcomment.com/js/integration.js?' + Date.now();
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(gc);
  })();

</script>





  
  
  <div class="container">
    <footer class="site-footer">
  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
  </p>
  

  <p class="powered-by">
    Â© 2021 Software-Defined Coffee &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.<br>
    Disclaimer: The views and opinions expressed on this blog are my own and do not reflect the views and opinions of my employer.
    
    
    
  </p>

</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
